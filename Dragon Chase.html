<html><head><title>Dragon Chase</title>
<script src="https://code.jquery.com/jquery-3.1.0.slim.min.js" 
integrity="sha256-cRpWjoSOw5KcyIOaZNo4i6fZ9tKPhYYb6i5T9RSVJG8=" 
crossorigin="anonymous"></script><style>
div {
	position: absolute;
	height: 10px;
	width: 100px;
	background-color: black;
}
span#guy {
	position: absolute;
	height: 100px;
	width: 100px;
	background-color: green;
	z-index: 1;
}
span#dragon {
	position: absolute;
	height: 100px;
	width: 100px;
	background-color: blue;
	z-index: 2;
}
body {
	overflow: hidden;
}
button {
	z-index: 3;
}
</style></head><body><span hidden id="stuff">
	<span id="guy"></span><span id="world"></span><span id="dragon"></span>
</span><span id="buttons">
	<button onclick="start(8, 0.5);">Level 1</button>
	<button onclick="start(8, 0.75);">Level 2</button>
	<button onclick="start(7, 0.75);">Level 3</button>
	<button onclick="start(6.25, 0.75);">Level 4</button>
	<button onclick="start(5, 0.75);">Level 5</button>
	<button onclick="start(5, 0.9);">Level 6</button>
	<button onclick="start(5, 1);">Level 7</button>
	<button onclick="start(7, 1.25);">Level 8</button>
	<button onclick="start(5, 1.25);">Level 9</button>
	<button onclick="start(5, 1.5);">Level 10</button>
</span><span id="messages"></span></body><script>
var objects = [],
	guy = {width:100,height:100,x:0,y:0},
	all_objects = [[]],
	relative_position = {top:75,left:0},
	total_height = 0,
	dragon = {speed: 0.9, width:100, height:100, x:500, y:500},
	going_left = false,
	going_right = false,
	jump_speed = 6.5;
	fall_speed = 0.1,
	accel = 0.04,
	falls = 0;
const spacing = 150;
fall();

function start(jump, speed) {
	$("#stuff")[0].removeAttribute("hidden");
	$("#buttons")[0].setAttribute("hidden", "hidden");
	$("#messages").empty();
	all_objects = [[]];
	total_height = 0;
	relative_position = {top:75,left:0};
	dragon.speed = speed;
	dragon.x = 500;
	dragon.y = 500;
	jump_speed = jump;
	fall_speed = 0.1;
	accel = 0.04;
	falls = 0;
	run_loop();
}

function run_loop() {
	var width = window.innerWidth/2,
		height = window.innerHeight/2;
	if (going_left) move_all(1,0);
	if (going_right) move_all(-1,0);
	$('#guy').css('left', width - guy.width/2);
	$('#guy').css('top', height - guy.height/2);
	const dist = Math.sqrt(dragon.x ** 2 + dragon.y ** 2);
	dragon.x -= dragon.x * dragon.speed / dist;
	dragon.y -= dragon.y * dragon.speed / dist;
	draw_board();
	if (dist < 100) {
		$("#messages").append('<h1 align="center">' + (dragon.speed > 0 ?
			'The dragon got you. You lose.' : 'You got the dragon. You win!') + '</h1>');
		$("#buttons")[0].removeAttribute("hidden");
		return;
	} else if (total_height >= 5000 && dragon.speed > 0) {
		dragon.speed = -dragon.speed;
		$("#messages").append('<h1 align="center">You got the sword!</h1>');
		setTimeout(function () { $("#messages").empty(); }, 1000);
	}
	if (dist > 1000) {
		if (dragon.speed > 0) {
			dragon.x -= dragon.x * (dist - 1000) / dist;
			dragon.y -= dragon.y * (dist - 1000) / dist;
		} else if (dist > 2000) {
			$("#messages").append('<h1 align="center">The dragon got away. You lose.</h1>');
			$("#buttons")[0].removeAttribute("hidden");
			return;
		}
	}
 	setTimeout(run_loop, 0);
}

$(document).keydown(function(e) {
	if (e.which == 37) {
		going_left = true;
	} else if (e.which == 39) {
		going_right = true;
	} else if (falls < 3 && fall_speed > 0 && e.which == 32) {
		fall_speed = -jump_speed;
	}
});
$(document).keyup(function(e) {
	switch(e.which) {
		case 37: going_left = false; break;
		case 39: going_right = false; break;
	}
});

$(window).resize(draw_board);

function draw_board() {
	const width = window.innerWidth/2,
		  height = window.innerHeight/2;
	// make sure all the board has objects on it
	while (relative_position.left < width) {
		add_column(false);
	}
	while (relative_position.top < height) {
		add_row(false);
	}
	while (all_objects.length * spacing < relative_position.left + width) {
		add_column(true);
	}
	while (all_objects[0].length * spacing < relative_position.top + height) {
		add_row(true);
	}
	// only draw objects that are close
	objects = [];
	for (var i = 0; i < all_objects.length; i++) {
		for (var j = 0; j < all_objects[i].length; j++) {	
			const left_pos = i * spacing - relative_position.left,
				   top_pos = j * spacing - relative_position.top;
			if (all_objects[i][j] && left_pos < spacing + width && left_pos > -spacing - width &&
								top_pos < spacing + height && top_pos > -spacing - height) {
				objects.push({x: left_pos, y: top_pos});
			}
		}
	}
	// draw the board
	$('#world').empty();
	for (var i = 0; i < objects.length; i++) {
		const obj = objects[i];
		if (obj.x - 50 < width && obj.x + 100 > - width &&
				obj.y - 5 < height && obj.y + 10 > - height) {
			$('#world').append('<div style="top:' +(height - obj.y - 5)+ 'px;' +
				'left:' +(width + obj.x - 50)+ 'px;"></div>');
		}
	}
	$("#dragon").css("left", width + dragon.x - dragon.width/2);
	$("#dragon").css("top", height - dragon.y - dragon.height/2);
}

function add_row(is_on_bottom) {
	for (var i = 0; i < all_objects.length; i++) {
		if (is_on_bottom) {
			all_objects[i].push(Math.random() < 0.25);
		} else {
			all_objects[i].unshift(Math.random() < 0.25);
			relative_position.top += spacing;
		}
	}
}

function add_column(is_last) {
	if (is_last) {
		all_objects.push([]);
	} else {
		all_objects.unshift([]);
		relative_position.left += spacing;
	}
	for (var i = 0; i < all_objects[1].length; i++) {
		if (is_last) {
			all_objects[all_objects.length - 1].push(Math.random() < 0.25);
		} else {
			all_objects[0].push(Math.random() < 0.25);
		}
	}
}

function fall() {
	falls++;
	move_all(0, fall_speed);
	fall_speed += accel;
	setTimeout(fall, 2);
}

function move_all(x,y) {
	var move_allowed = true;
	for (var i = 0; i < objects.length; i++) {
		var obj = objects[i];
		if (overlap(guy, {x:obj.x + x, y:obj.y + y})) {
			move_allowed = false;
			if (y != 0) {
				fall_speed = 0;
				falls = 0;
			}
			break;
		}
	}
	if (move_allowed) {
		relative_position.top -= y;
		relative_position.left -= x;
		total_height -= y;
		dragon.x += x;
		dragon.y += y;
		draw_board();
	}
}

function overlap1d(x1, width1, x2, width2) {
	return (
		(x1 <= x2 && x2 - width2/2 < x1 + width1/2)||
		(x2 <= x1 && x1 - width1/2 < x2 + width2/2));
}

function overlap(object1, object2) {
	var xol = overlap1d(object1.x, object1.width, object2.x, 100),
		yol = overlap1d(object1.y, object1.height, object2.y, 10);
	return (xol && yol);
}
</script></html>